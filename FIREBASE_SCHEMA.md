# Firebase Schema Documentation

This document describes the Firestore database schema used by cellPACK. Collections are accessed by the client (cellPACK Studio), the core package(backend), or both.

## Collections

| Collection Name      | Purpose                                                           | Key Fields                                                                                                                                          | Read                                                                         | Write                                                        | Cleanup Policy                                | Related Process                                                  | Notes                                           |
| -------------------- | ----------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------------- | ---------------------------------------------------------------- | ----------------------------------------------- |
| **recipes**          | Stores the full-structured recipes                                | `name`, `id`, `dedup_hash`, `description`, `version`, `format_version`, `bounding_box`, `composition`, `objects`, `gradients`, `optional_gradients` | Recipe loading, UI display, user edit comparison, packing execution          | Backend uploads via admin CLI tool                           | **No cleanup** - Permanent storage            | Recipe loading, reference resolution, comparison with user edits | `optional_gradients` manually added             |
| **recipes_edited**   | Stores user-modified recipes temporarily                          | Same as `recipes` + `recipe_path`, `timestamp`                                                                                                      | Backend retrieval for packing                                                | User submits modified recipe (differs from default)          | **No automated cleanup** - Manual only        | User recipe submission, packing job submission                   | Unnested format, no reference resolution needed |
| **configs**          | Stores packing configuration settings                             | Referenced by path (e.g., `firebase:configs/{id}`)                                                                                                  | Building packing job request, backend reads during packing                   | Backend admin uploads via CLI tool                           | **No cleanup** - Permanent storage            | Packing job configuration, submitted to Docker server            | Referenced but not directly queried by frontend |
| **objects**          | Stores object definitions (molecules, organelles)                 | `name`, `id`, `dedup_hash`, `type`, `color`, `packing_mode`, `place_method`, `radius`, `inherit`, `gradient`, `representations`, `jitter_attempts`  | Recipe reference resolution, inheritance chain resolution, packing execution | Backend admin uploads with deduplication                     | **No cleanup** - Permanent storage            | Reference resolution in recipes, inheritance chain resolution    | Handles inheritance chains                      |
| **gradients**        | Stores gradient definitions for spatial distributions             | `name`, `id`, `dedup_hash`, `description`, `mode`, `mode_settings`, `weight_mode`, `pick_mode`, `reversed`, `invert`                                | Recipe/object reference resolution, editable field options                   | Backend admin uploads with deduplication                     | **No cleanup** - Permanent storage            | Reference resolution, gradient options for editable fields       | Can be combined (multiple per object)           |
| **composition**      | Stores composition definitions (what objects go where)            | `name`, `id`, `dedup_hash`, `count`, `molarity`, `object`, `inherit`, `regions` (interior, surface, leaflets)                                       | Recipe reference resolution, region-based placement                          | Backend admin uploads with topological sort                  | **No cleanup** - Permanent storage            | Reference resolution, region-based object placement              | Handles nested composition dependencies         |
| **job_status**       | Tracks AWS packing job status                                     | `status`, `error_message`, `outputs_directory`, `result_path`, `timestamp`                                                                          | Frontend polling (every 500ms), progress monitoring, result retrieval        | Backend updates during job execution (RUNNING â†’ DONE/FAILED) | **No automated cleanup** - Manual only        | Job monitoring, status polling, result retrieval                 | Not in backend default collection list          |
| **example_packings** | Maps example recipes to configs and defines UI metadata           | `name` (display name), `recipe` (recipe ID), `config` (config ID), `editable_fields` (array of field IDs), `result_path`                            | App startup, recipe dropdown population                                      | Manual admin setup (for frontend only)                      | **No cleanup** - Permanent storage            | App initialization, recipe dropdown population, UI configuration | **Frontend only** - Not used by backend         |
| **editable_fields**  | Defines which recipe fields users can edit in UI                  | `id`, `name`, `data_type`, `input_type`, `description`, `path`, `min`, `max`, `options`, `gradient_options`, `conversion_factor`, `unit`            | App initialization, form generation, input validation                        | Manual admin setup (for frontend only)                      | **No cleanup** - Permanent storage            | Dynamic form generation, input validation, gradient options      | **Frontend only** - Not used by backend         |
| **results**          | Stores Simularium result metadata for auto-opening (backend only) | `batch_job_id`, `timestamp`, `url` (Simularium result S3 URL), `user`                                                                               | Backend cleanup validation (S3 URL check)                                    | Successful packing completion with Simularium output         | **180 days** - Cleaned if S3 URL inaccessible | Result archiving, user history tracking, result URL storage      | Cleanup validates S3 existence                  |

